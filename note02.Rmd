---
title: "note02"
output: 
  html_notebook:
    df_print: kable
---

```{r}
options(paged.print = FALSE)
```

# 2 Exploring Longitudinal Data on Change

## 2.1 Creating a longitudinal data set

```{r}
library(tidyverse)
```

```{r}
tolerance <- read_csv("https://stats.idre.ucla.edu/wp-content/uploads/2016/02/tolerance1.txt", col_names = T)
tolerance
```

```{r}
tolerance %>%
  count()
```

```{r}
tolerance %>%
  nrow()
```

```{r}
cor(tolerance[, 2:6]) %>%
  round(digits = 2)
```

```{r}
cor(tolerance[, 2:6]) %>%
  data.frame() %>%
  rownames_to_column("row") %>%
  pivot_longer(-row, names_to = "column", values_to = "correlation") %>%
  mutate(row = factor(row) %>% fct_rev(.)) %>%
  ggplot(aes(x = column, y = row)) +
  geom_raster(aes(fill = correlation)) +
  geom_text(aes(label = round(correlation, digits = 2)), size = 3.5) +
  scale_fill_gradient(low = "white", high = "red4", limits = c(0, 1)) +
  scale_x_discrete(NULL, position = "top", expand = c(0, 0)) +
  scale_y_discrete(NULL, expand = c(0, 0)) +
  theme(axis.ticks = element_blank()) +
  coord_fixed(ratio = 1)
```

```{r}
psych::lowerCor(tolerance[, 2:6])
```

```{r}
tolerance_pp <- read_csv("https://stats.idre.ucla.edu/wp-content/uploads/2016/02/tolerance1_pp.txt", col_names = T)
tolerance_pp # %>%
# slice(1:9, 76:80)
```

```{r}
tolerance_pp %>%
  distinct(id) %>%
  count()
```

```{r}
tolerance_pp %>%
  count(id)
```

```{r}
tolerance %>%
  pivot_longer(tol11:tol15, names_to = "age", values_to = "tolerance") %>%
  mutate(age = as.integer(str_remove(age, "tol"))) %>%
  arrange(id, age) %>%
  relocate(id, tolerance, age)
```

```{r}
tolerance_pp %>%
  mutate(age = str_c("tol", age)) %>%
  select(-time) %>%
  pivot_wider(names_from = age, values_from = tolerance)
```

## 2.2 Descriptive analysis of individual change over time

```{r}
tolerance_pp %>%
  ggplot(aes(x = age, y = tolerance)) +
  geom_point() +
  geom_line() +
  coord_cartesian(ylim = c(1, 4)) +
  facet_wrap(~id) +
  theme(panel.grid = element_blank())
# theme(aspect.ratio = 0.7)
```

```{r}
tolerance_pp %>%
  ggplot(aes(x = age, y = tolerance, group = id)) +
  geom_point() +
  stat_smooth(method = "loess", se = FALSE, span = .9) +
  coord_cartesian(ylim = c(1, 4)) +
  facet_wrap(~id) +
  theme(panel.grid = element_blank())
```

```{r}
by_id <-
  tolerance_pp %>%
  group_by(id) %>%
  nest()
by_id
```

```{r}
by_id$data[[1]]
```

```{r}
by_id$data[[1]] %>%
  mutate(age_minus_11 = age - 11)
```

```{r}
library(brms)
```

```{r}
fit2.1 <-
  brm(
    data = by_id$data[[1]],
    formula = tolerance ~ 1 + time,
    prior = prior(normal(0, 2), class = b),
    iter = 4000, chains = 4, cores = 4,
    seed = 2,
    file = "fits/fit02.01"
  )
```

```{r}
print(fit2.1)
```

```{r}
fit2.1$prior
```

```{r}
fit2.2 <-
  update(fit2.1,
    newdata = by_id$data[[2]],
    control = list(adapt_delta = .9),
    file = "fits/fit02.02"
  )
```

```{r}
fit2.2
```

```{r}
bayes_R2(fit2.2)
```

```{r}
bayes_R2(fit2.2, summary = FALSE) %>%
  str()
```

```{r}
bayes_R2(fit2.2, summary = FALSE) %>%
  data.frame() %>%
  ggplot(aes(R2)) +
  geom_density(fill = "black") +
  scale_x_continuous(expression(italic(R)[Bayesian]^2), limits = c(0, 1)) +
  scale_y_continuous(NULL, breaks = NULL) +
  theme(panel.grid = element_blank())
```

```{r}
bayes_R2(fit2.2, summary = FALSE) %>%
  data.frame() %>%
  summarize(
    mean = mean(R2),
    median = median(R2),
    mode = tidybayes::Mode(R2)
  )
```

```{r}
bayes_R2(fit2.2)
bayes_R2(fit2.2, robust = TRUE)
```

```{r}
fits <-
  by_id %>%
  mutate(model = map(data, ~ update(fit2.1, newdata = ., seed = 2)))
```

```{r}
fits
```

```{r}
mean_structure <-
  fits %>%
  mutate(coefs = map(model, ~ posterior_summary(.)[1:2, 1:2] %>%
    data.frame() %>%
    rownames_to_column("coefficients"))) %>%
  unnest(coefs) %>%
  select(-data, -model) %>%
  unite(temp, Estimate, Est.Error) %>%
  pivot_wider(names_from = coefficients, values_from = temp) %>%
  separate(b_Intercept, into = c("init_stat_est", "init_stat_sd"), sep = "_") %>%
  separate(b_time, into = c("rate_change_est", "rate_change_sd"), sep = "_") %>%
  mutate(across(where(is.character), ~ round(as.double(.), digits = 2))) %>%
  ungroup()
mean_structure
```

```{r}
residual_variance <-
  fits %>%
  mutate(
    residual_variance = map_dbl(model, ~ posterior_summary(.)[3, 1]^2)
  ) %>%
  mutate(across(is.double, round, digits = 2)) %>%
  select(id, residual_variance)
residual_variance
```

```{r}
r2 <-
  fits %>%
  mutate(r2 = map_dbl(model, ~ bayes_R2(., robust = TRUE)[1])) %>%
  mutate(across(is.double, round, digits = 2)) %>%
  select(id, r2)
r2
```

```{r}
table <-
  fits %>%
  unnest(data) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id, male, exposure) %>%
  left_join(mean_structure, by = "id") %>%
  left_join(residual_variance, by = "id") %>%
  left_join(r2, by = "id") %>%
  rename(residual_var = residual_variance) %>%
  relocate(id, init_stat_est:r2) %>%
  ungroup()
table %>%
  flextable::flextable()
```

```{r}
table %>%
  pull(init_stat_est) %>%
  stem(scale = 2)
```

```{r}
table %>%
  pull(rate_change_est) %>%
  stem(scale = 2)
```

```{r}
table %>%
  pull(residual_var) %>%
  stem(scale = 2)
```

```{r}
table %>%
  pull(r2) %>%
  stem(scale = 2)
```

```{r, fig.width=2.5, fig.height=2.5}
by_id %>%
  unnest(data) %>%
  ggplot(aes(time, tolerance, group = id)) +
  geom_point() +
  geom_abline(
    data = mean_structure,
    aes(
      intercept = init_stat_est,
      slope = rate_change_est, group = id
    ),
    color = "blue"
  ) +
  scale_x_continuous(breaks = 0:4, labels = 0:4 + 11) +
  coord_cartesian(ylim = c(0, 4)) +
  facet_wrap(~id) +
  theme(panel.grid = element_blank())
```

## 2.3 Exploring differences in change across people

## 2.4 Improving the precision and reliability of OLS / single-level-Bayesian-estimated rates of change: Lessons for research design
